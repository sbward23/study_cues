---
title: "Analyses"
output: 
  html_document:
    toc: true 
    toc_depth: 4
editor_options: 
  chunk_output_type: console
---

```{css, echo = FALSE}
pre, code {
  max-height: 500px;
  overflow-y: auto;
  white-space: pre !important; 
  overflow-x: auto
}
```

```{r}
# to detect and warn about conflicts
library(conflicted)

conflict_prefer("filter", "dplyr")
conflict_prefer("select", "dplyr")
conflicts_prefer(lmerTest::lmer)
```

```{r}
# to read in data
library(readr)

path_ready <- "_data/data_ready"
path_objects <- "/objects"

# for data wrangling and cleaning
library(tidyverse)
library(janitor)
library(lubridate)
library(psych)
library(recipes)
library(dplyr)
library(lme4)
library(ordinal)
library(lmerTest)
library(kableExtra)

source(here::here("_scripts/functions.R"))
```

```{r}
d <- read_rds(here::here(path_ready, "imp1_ana.rds"))
```

## Analysis

**H01:** Verbal consent cue use was significantly higher during
penetrative sexual encounters compared to encounters that did not
progress beyond kissing or touching. This effect was observed within
individuals, indicating that when a given participant engaged in
penetrative sexual activity, they reported greater use of verbal consent
cues than during their own contact-only encounters. Although the
magnitude of this effect varied across individuals, the average
within-person association was positive.

```{r}
m_act <- lmer(
  verb_yj ~ act_penetration_wp + act_penetration_pm_c +
    (1 + act_penetration_wp + day_c || nid),
  data = d,
  REML = TRUE)

# summary(m_act)

coef_h01_lmm  <- tidy_fixed(m_act)

coef_h01_lmm |> 
  write_csv(here::here("objects/coef_h01_lmm.csv"))
```

```{r}
act_clmm <- fit_mixed_model(
  outcome    = "verb_bins",
  predictors = c("act_penetration_wp + act_penetration_pm_c"),
  framework  = "clmm",
  random_slopes = "act_penetration_wp", "day_c",
  data = d)

summary(act_clmm)
coef_h01_clmm <- tidy_fixed(act_clmm)
```

**H02:** Encounters occurring in the context of shared romantic history
(i.e., past or present dating partner) involved higher nonverbal consent
cue use than encounters occurring with less familiar partners who met the day of the sexual encounter.

```{r}
m_h02 <- fit_mixed_model(
  outcome    = "nvrb_yj",
  predictors = c("fam3_friend_acq_wp", "fam3_romantic_wp",
                 "fam3_friend_acq_pm_c", "fam3_romantic_pm_c"),
  framework  = "lmm",
  random_slopes = NULL,
  data = d)

summary(m_h02)

h02_clmm <- fit_mixed_model(
  outcome    = "nonvb_bins",
  predictors = c("fam3_friend_acq_wp", "fam3_romantic_wp",
                 "fam3_friend_acq_pm_c", "fam3_romantic_pm_c"),
  framework  = "clmm",
  random_slopes = NULL,
  data = d)

summary(h02_clmm)
```

```{r}
m_h02s <- fit_mixed_model(
  outcome    = "nvrb_yj",
  predictors = c("fam2_more_wp", "fam2_more_pm_c"),
  framework  = "lmm",
  random_slopes = NULL,
  data = d)

summary(m_h02s)

h02s_clmm <- fit_mixed_model(
  outcome    = "nonvb_bins",
  predictors = c("fam2_more_wp", "fam2_more_pm_c"),
  framework  = "clmm",
  random_slopes = NULL,
  data = d)

summary(h02s_clmm)
```


**H03:** Gender was not significantly associated with nonverbal consent
cue use.

```{r}
m_h03 <- fit_mixed_model(
  outcome    = "nvrb_yj",
  predictors = c("gend_di"),
  framework  = "lmm",
  random_slopes = NULL,
  data = d)

summary(m_h03)

h03_clmm <- fit_mixed_model(
  outcome    = "nonvb_bins",
  predictors = c("gend_di"),
  framework  = "clmm",
  random_slopes = NULL,
  data = d)

summary(h03_clmm) # conflicting findings -- gender significant for clmm...
```

**To examine associations between alcohol and consent cue use during
sexual encounters.**

-   H1.1: Alcohol consumption (# of drinks) will be significantly,
    negatively associated with both verbal and nonverbal consent cue
    use.

```{r}
# VERBAL
m_h11 <- fit_mixed_model(
  outcome    = "verb_yj",
  predictors = c("drink_wp", "drink_pm_c"),
  framework  = "lmm",
  random_slopes = "day_c",
  data = d)

summary(m_h11)

h11_clmm <- fit_mixed_model(
  outcome    = "verb_bins",
  predictors = c("drink_wp", "drink_pm_c"),
  framework  = "clmm",
  random_slopes = "day_c",
  data = d)

summary(h11_clmm)
```

```{r}
# NONVERBAL
nv_h11 <- fit_mixed_model(
  outcome    = "nvrb_yj",
  predictors = c("drink_wp", "drink_pm_c"),
  framework  = "lmm",
  random_slopes = NULL,
  data = d)

summary(nv_h11)

nv_h11_clmm <- fit_mixed_model(
  outcome    = "nonvb_bins",
  predictors = c("drink_wp", "drink_pm_c"),
  framework  = "clmm",
  random_slopes = NULL,
  data = d)

summary(nv_h11_clmm)
```


-   H1.2: The continuous absolute difference between subjective
    participant and perceived partner intoxication ("intoxication
    disparity") will be significantly, negatively associated with verbal
    cue use.

-   Between-person differences in intoxication disparity were associated
    with lower verbal consent cue use, whereas encounter-level
    deviations in disparity were unrelated to verbal consent
    communication.

```{r}
# VERBAL
m_h12 <- fit_mixed_model(
  outcome    = "verb_yj",
  predictors = c("parity_con_wp", "parity_con_pm_c"),
  framework  = "lmm",
  random_slopes = "day_c",
  data = d)

summary(m_h12)

h12_clmm <- fit_mixed_model(
  outcome    = "verb_bins",
  predictors = c("parity_con_wp", "parity_con_pm_c"),
  framework  = "clmm",
  random_slopes = "day_c",
  data = d)

summary(h12_clmm)
```

-   H1.3: Drinking venue attendance will be significantly, negatively
    associated with both nonverbal and verbal cue use. We expect this
    negative effect will be more pronounced for nonverbal cues.

-   Across both verbal and nonverbal consent outcomes, between-person
    differences in bar-and-party attendance—but not event-level
    deviations—were associated with lower consent cue use, with
    particularly strong associations observed for nonverbal
    communication.

```{r}
# VERBAL
m_h13 <- fit_mixed_model(
  outcome    = "verb_yj",
  predictors = c("bpa_bar_party_wp", "bpa_bar_party_pm_c"),
  framework  = "lmm",
  random_slopes = "day_c",
  data = d)

summary(m_h13)

h13_clmm <- fit_mixed_model(
  outcome    = "verb_bins",
  predictors = c("bpa_bar_party_wp", "bpa_bar_party_pm_c"),
  framework  = "clmm",
  random_slopes = "day_c",
  data = d)

summary(h13_clmm)
```


```{r}
# NONVERBAL
nv_h13 <- fit_mixed_model(
  outcome    = "nvrb_yj",
  predictors = c("bpa_bar_party_wp", "bpa_bar_party_pm_c"),
  framework  = "lmm",
  random_slopes = NULL,
  data = d)

summary(nv_h13)

nv_h13_clmm <- fit_mixed_model(
  outcome    = "nonvb_bins",
  predictors = c("bpa_bar_party_wp", "bpa_bar_party_pm_c"),
  framework  = "clmm",
  random_slopes = NULL,
  data = d)

summary(nv_h13_clmm)
```

-   H1.4: Among alcohol-involved encounters, there will be an inverted-U
    relationship between both alcohol consumption and subjective
    intoxication and verbal cue use: low → moderate = verbal consent
    increases; moderate → high = verbal consent decreases.
    
```{r}

```


-   H2.1: The negative association between alcohol consumption and
    verbal cue use will be weaker for penetrative behaviors and stronger
    for encounters involving kissing/touching.

```{r}
h21 <- lmer(
  verb_yj ~
    drink_wp * s_act +
    drink_pm_c * s_act +
    (1 + act_penetration_wp + day_c || nid),
  data = d,
  REML = TRUE)

summary(h21)

h21_clmm <- clmm(
  verb_bins ~ 
    drink_wp * s_act +
    drink_pm_c * s_act + 
    (1 + act_penetration_wp + day_c | nid),
                  data = d, 
                  link = "logit", Hess = TRUE)

summary(h21_clmm)
```

-   H2.2: The negative association between drinking venue attendance and
    nonverbal cue use will be stronger among less familiar partners.

```{r}
h22 <- lmer(
  nvrb_yj ~
    bpa_bar_party_wp * fam_lev +
    bpa_bar_party_pm_c * fam_lev +
    (1 | nid),
  data = d,
  REML = TRUE)

summary(h22)

h22_clmm <- clmm(
  nonvb_bins ~
    bpa_bar_party_wp * fam_lev +
    bpa_bar_party_pm_c * fam_lev +
    (1 | nid),
  data = d, 
  link = "logit", Hess = TRUE)

summary(h22_clmm)
```

-   H2.3: The negative association between intoxication disparity and
    verbal cue use will be stronger among men compared to women and GNC
    individuals.

```{r}
h23 <- lmer(
  verb_yj ~ 
    parity_con_wp * gend_di + 
    parity_con_pm_c * gend_di +
    (1 + day_c | nid),
  data = d,
  REML = TRUE)

summary(h23)

h23_clmm <- clmm(
  verb_bins ~ 
    parity_con_wp * gend_di + 
    parity_con_pm_c * gend_di +
    (1 + day_c | nid),
  data = d, 
  link = "logit", Hess = TRUE)

summary(h23_clmm)
```

**Evaluate the extent to which distal individual factors predict
consent cue use after controlling for relevant contextual correlates.**

-   H3.1: Social desirability bias and rape myth rejection will be
    positively associated with verbal cues after controlling for partner
    familiarity and behavior type. *Supported across frameworks*

```{r}
names(d)

h31v <- lmer(
  verb_yj ~ 
    bidr_c + irma_c +
    fam_lev + s_act +
    (1 + day_c | nid), # didn't converge w/ slope for act
  data = d,
  REML = TRUE)

summary(h31v)

h31v_clmm <- fit_mixed_model(
  outcome    = "verb_bins",
  predictors = c("bidr_c", "irma_c", "fam_lev", "s_act"),
  framework  = "clmm",
  random_slopes = "day_c",
  data = d)

summary(h31v_clmm)
```

-   H3.2: Permissive individual and *perceived peer* attitudes toward
    alcohol and coercion will be negatively associated with verbal cues
    after controlling for partner familiarity and behavior type.
    
```{r}
names(d)

# does not converge with both attitude vars, 3-level fam, and day_c slope 
h32v <- fit_mixed_model(
  outcome    = "verb_yj",
  predictors = c("ppat_c", "asco_c", "fam_rank", "s_act"),
  framework  = "lmm",
  random_slopes = "day_c",
  data = d)

summary(h32v)

h32v_clmm <- fit_mixed_model(
  outcome    = "verb_bins",
  predictors = c("ppat_c", "asco_c", "fam_lev", "s_act"),
  framework  = "clmm",
  random_slopes = "day_c",
  data = d)

summary(h32v_clmm)
```


-   H3.3: Hazardous alcohol consumption will be negatively associated
    with both verbal and nonverbal cues after controlling for partner
    familiarity and behavior type. *Not supported for verbal or nonverbal*

```{r}
# VERBAL
h33v <- fit_mixed_model(
  outcome    = "verb_yj",
  predictors = c("auds_c", "fam_lev", "s_act"),
  framework  = "lmm",
  random_slopes = "day_c",
  data = d)

summary(h33v)

h33v_clmm <- fit_mixed_model(
  outcome    = "verb_bins",
  predictors = c("auds_c", "fam_lev", "s_act"),
  framework  = "clmm",
  random_slopes = "day_c",
  data = d)

summary(h33v_clmm)
```

```{r}
# NONVERBAL 
h33n <- fit_mixed_model(
  outcome    = "nvrb_yj",
  predictors = c("auds_c", "fam_lev", "s_act"),
  framework  = "lmm",
  random_slopes = NULL,
  data = d)

summary(h33n)

h33n_clmm <- fit_mixed_model(
  outcome    = "nonvb_bins",
  predictors = c("auds_c", "fam_lev", "s_act"),
  framework  = "clmm",
  random_slopes = NULL,
  data = d)

summary(h33n_clmm)
```


-   H3.4: Permissive attitudes toward alcohol and coercion will
    strengthen the negative association between intoxication disparity
    and verbal cue use after controlling for partner familiarity and
    behavior type.
    
```{r}
h34v <- lmer(
  verb_yj ~ 
    parity_con_wp * asco_c + 
    parity_con_pm_c * asco_c +
    fam_lev + s_act +
    (1 + day_c | nid),
  data = d,
  REML = TRUE)

summary(h34v)

h34v_clmm <- clmm(
  verb_bins ~ 
    parity_con_wp * asco_c + 
    parity_con_pm_c * asco_c +
    fam_lev + s_act +
    (1 + day_c | nid),
  data = d, 
  link = "logit", Hess = TRUE)

summary(h34v_clmm)
```
  
