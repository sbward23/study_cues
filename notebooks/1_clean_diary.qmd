---
title: "Cleaning diary data"
output: 
  html_document:
    toc: true 
    toc_depth: 4
editor_options: 
  chunk_output_type: console
---

```{css, echo = FALSE}
pre, code {
  max-height: 500px;
  overflow-y: auto;
  white-space: pre !important; 
  overflow-x: auto
}
```

```{r}
# to detect and warn about conflicts
library(conflicted)

conflict_prefer("filter", "dplyr")
conflict_prefer("select", "dplyr")
```

```{r}
# to read in data
library(readr)

path_nids <- "_data/data_process"
path_ready <- "_data/data_ready"

# for data wrangling and cleaning
library(tidyverse)
library(janitor)
library(lubridate)
library(psych)

source(here::here("_scripts/functions.R"))
```

```{r,warning=FALSE}
baseline <- read_csv(here::here(path_nids,"baseline_nid.csv"), show_col_types = FALSE)

data <- read_csv(here::here(path_nids, "diary_nid.csv"), col_types = cols(
  StartDate = col_character(),
  EndDate = col_character(),
  RecordedDate = col_character(),
  AuDB4 = col_character(),
  AuDB4_7_TEXT = col_character(),
  AuDB5 = col_character(),
  AuDB5_6_TEXT = col_character(),
  Q186 = col_character(),
  Q186_8_TEXT = col_character(),
  PSB2 = col_character(),
  Q211 = col_character(),
  PSB15 = col_character(),
  OSBB2 = col_character(),
  OSBB6 = col_character(),
  OSBB10_11 = col_character(),
  SSAB3 = col_character(),
  SSAB6_7 = col_character(),
  Q215 = col_character())) %>%
    clean_names() %>%
    glimpse()
```

# Initial cleaning

Format dates

```{r}
data <- data %>% 
  mutate(start_date = as_datetime(start_date, tz = "America/Chicago"),
         end_date = as_datetime(end_date, tz = "America/Chicago"),
         recorded_date = as_datetime(recorded_date, tz = "America/Chicago"),
         date = date(start_date))
```

Confirm participant identifiers

```{r}
nrow(data) # 6928
length(unique(data$nid)) # 278 - nid derived from sona_id; links baseline to daily surveys
length(unique(data$pid)) # 278 - pid exclusive to daily surveys
```

## Remove blank surveys

Remove 136 completely blank surveys

```{r}
data_empty <- data %>% 
  select(au_db1:e4) 

data_empty_rows <- which(rowSums(is.na(data_empty)) == ncol(data_empty))

length(data_empty_rows)

data <- data %>% 
  filter(!row_number() %in% data_empty_rows)
```

## Identify duplicates

255 duplicates (i.e., more than one survey on same day for one pid)

```{r}
data %>% 
  group_by(pid, date) %>% 
  count() %>% 
   ungroup() %>% 
  filter(n > 1) %>% 
  arrange(desc(n))
```

Check if responses are same on duplicates

```{r}
duplicates <- data %>% 
  group_by(pid, date) %>% 
  count() %>% 
  ungroup() %>% 
  filter(n > 1) %>% 
  left_join(data, by = c("pid", "date")) %>% 
  filter(!is.na(n)) 

duplicates %>% 
  distinct() %>% 
  nrow() 

duplicates %>% 
  select(-c(4:20)) %>% 
  distinct() %>% 
  nrow()

```

Remove duplicates that are same on all columns except survey metadata\
Will keep first survey so we have start time of first survey that day

```{r}
duplicate_responses <- which(duplicates %>% 
  select(-c(4:20)) %>% 
  duplicated())

duplicate_ids <- duplicates %>% 
  filter(row_number() %in% duplicate_responses) %>% 
  pull(response_id)

data <- data %>% 
  filter(!response_id %in% duplicate_ids)
```

Left with 197 duplicate surveys

```{r}
data %>% 
  group_by(pid, date) %>% 
  count() %>% 
   ungroup() %>% 
  filter(n > 1) %>% 
  arrange(desc(n))


duplicates <- data %>% 
  group_by(pid, date) %>% 
  count() %>% 
  ungroup() %>% 
  filter(n > 1) %>% 
  left_join(data, by = c("pid", "date")) %>% 
  filter(!is.na(n)) 
```

Check for duplicate surveys with no data other than screening questions for branching

```{r}
data_empty <- duplicates %>% 
  select(au_db2:e4) 

data_empty_rows <- which(rowSums(is.na(data_empty)) == ncol(data_empty))

duplicates %>% 
  filter(row_number() %in% data_empty_rows) %>%
  group_by(nid, date) %>%
  count() %>% 
  arrange(desc(n))

# 1 nid has 2 mostly blank duplicates - check to see if they have another survey on that day
# they do!
duplicates %>% 
  filter(nid == "5140108" & date == "2022-11-16")
```

filter out mostly blank duplicates (i.e., only responded to branching questions and have more complete survey on same day)

```{r}
response_ids <- duplicates %>% 
  filter(row_number() %in% data_empty_rows) %>% 
  pull(response_id)

data <- data %>% 
  filter(!response_id %in% response_ids)
```

159 duplicates left

```{r}
data %>% 
  group_by(pid, date) %>% 
  count() %>% 
   ungroup() %>% 
  filter(n > 1) %>% 
  arrange(desc(n))


duplicates <- data %>% 
  group_by(pid, date) %>% 
  count() %>% 
  ungroup() %>% 
  filter(n > 1) %>% 
  left_join(data, by = c("pid", "date")) %>% 
  filter(!is.na(n)) 
```

Look at surveys taken at midnight to see if date is incorrect due to being slightly after midnight

```{r}
data %>% 
  filter(hour(start_date) < 2) %>% 
  select(nid, start_date)
```

5/8 Duplicate surveys taken at midnight and later that night and are missing survey day before- determined midnight survey was for previous day. Correcting new date variable here.

Note: this date variable lines up roughly to day on study but will not be used for making labels/prediction windows. The raw end survey time will be used for this.

```{r}
# data |> 
#   filter(nid == "9796568") |> 
#   select(date, response_id, start_date) |> 
#   print(n = Inf)
# 
# data |> 
#   filter(nid == "9740303") |> 
#   select(date, response_id, start_date) |> 
#   print(n = Inf)
# 
# data |> 
#   filter(nid == "6681525") |> 
#   select(date, response_id, start_date) |> 
#   print(n = Inf)
# 
# data |> 
#   filter(nid == "3256800") |> 
#   select(date, response_id, start_date) |> 
#   print(n = Inf)
# 
# data |> 
#   filter(nid == "9328313") |> 
#   select(date, response_id, start_date) |> 
#   print(n = Inf)
# 
# data |> 
#   filter(nid == "2564475") |> 
#   select(date, response_id, start_date) |> 
#   print(n = Inf)
# 
# data |> 
#   filter(nid == "8311815") |> 
#   select(date, response_id, start_date) |> 
#   print(n = Inf)

data <- data |> 
  mutate(date = if_else(response_id == "R_28GUR3cJzRXaTPC", date("2022-11-10"), 
                        date),
         date = if_else(response_id == "R_3lEREAWesaFQSnG", date("2022-10-28"),
                        date),
         date = if_else(response_id == "R_21G38UK4RkS5Ky5", date("2022-10-28"),
                        date),
         date = if_else(response_id == "R_2q1tWYtBw0XbZlM", date("2022-11-05"),
                        date),
         date = if_else(response_id == "R_2c63k6bRzLwkyJT", date("2022-11-14"),
                        date))
```

Look at differences in branching questions among duplicates

```{r}
duplicates <- data %>% 
  group_by(pid, date) %>% 
  count() %>% 
  ungroup() %>% 
  filter(n > 1) %>% 
  left_join(data, by = c("pid", "date")) %>% 
  filter(!is.na(n)) 

duplicates_branch_match <- duplicates %>% 
  select(nid, date, au_db1:porn_screen_fu) %>% 
  distinct() %>% 
  group_by(nid, date) %>% 
  count() %>% 
  filter(n == 1) %>% 
  select(-n) %>% 
  left_join(duplicates, by = c("nid", "date"))
```

Look at mental health questions

```{r}
duplicates_branch_match %>% 
  filter(au_db1 == 2 & psb1 == 2 & osbb1 == 2 & ssab1 == 2 & 
                 drugs_screen_fu == 2 & bpa1 == 2 & porn_screen_fu == 2) %>% 
  select(nid, date, response_id, start_date, mis1:e4) %>% 
  glimpse()
```

If answers same keep more complete survey then first survey

```{r}
data <- data %>% 
  filter(!response_id %in% c("R_3nl1aO9wz2HoliI", "R_3j0cQeVBMt5s0Y0",
         "R_27UvVfdaNbLQIvA", "R_1roCa7SNA64ll6b", "R_3JjZhfFzAc87KLQ",
         "R_3eb3ZXUu8ma62HW", "R_1goOMvxm2OO37xE", "R_2anOsrKT0rWfpyh",
         "R_2v7x6suXsPA7lCE", "R_3n1q190pGvgnJvW", "R_3Mmsiry2UFC250F",
         "R_1CD8AVjRYbvFOSE", "R_1pGNAcQtKqkDl4Y", "R_1Kp50zwQe1EHJ9A"))
```

If answers differ only by 1-2 items, keep more complete survey or if both complete keep first survey

```{r}
data <- data %>% 
  filter(!response_id %in% c("R_2e3FNxw2bfXqVhD", "R_3PuSSFXqM2rg75H",
                             "R_21jN639l8fmHhv7", "R_24cL375YzQDqcNs",
                             "R_27InzwQuaYLA91G", "R_2q3iIQW0ju1U0TC",
                             "R_2aQz1zTeseotOnq", "R_aYqSgHFF1qJem9r",
                             "R_1mI5Ldgr8fNIDJn", "R_5mZeozvhOLfQHyF",
                             "R_3G2MmYKXMfOPpw8", "R_12hVYRgqDPJX7KM",
                             "R_V418rtMyfoi5rTb", "R_1zfPXLu96CO1qfv", 
                             "R_1FOH5eJeKZKDLaE", "R_vMHmj0vxM2bn98R",
                             "R_1lt7qIcUoYRj7s2", "R_vAMr55UaumNxt9n",
                             "R_xbVy68nr7ZEHK01", "R_12QL6qI8bCV2YPL",
                             "R_3rZiJxcPpT5dgx4", "R_27PDNNBEMijZqxM",
                             "R_3FJ7693Okhf5xgn", "R_DFXWiS5oKvsSevn",
                             "R_uxoQLKB3iUwZvJ7", "R_5aMdcpvNUaRgepH",
                             "R_1GWuG4iIs1EgIdy", "R_3nUxYS964qGdnyn",
                             "R_1jIj5b2QDOMaSgO", "R_2QFE8b5dMtmd3JL",
                             "R_ZjK1J5cruthIO6R", "R_1kZV0eMBz42WEFW",
                             "R_1FfEfAVl19LMXFw", "R_3gZOFZK2937JZqj"))
```

Look at other matching branch surveys

```{r}
# duplicates_branch_match %>% 
#   filter(au_db1 == 1 & psb1 == 2 & osbb1 == 2 & ssab1 == 2 & 
#                  drugs_screen_fu == 2 & bpa1 == 2 & porn_screen_fu == 2) %>% 
#   select(nid, date, response_id, start_date, au_db2:e4) %>% 
#   view()
# 
# duplicates_branch_match %>% 
#   filter(au_db1 == 1 & psb1 == 1 & osbb1 == 2 & ssab1 == 2 & 
#                  drugs_screen_fu == 2 & bpa1 == 2 & porn_screen_fu == 2) %>% 
#   select(nid, date, response_id, start_date, au_db2:e4) %>% 
#   view()
# 
# duplicates_branch_match %>% 
#   filter(au_db1 == 2 & psb1 == 2 & osbb1 == 1 & ssab1 == 1 & 
#                  drugs_screen_fu == 2 & bpa1 == 2 & porn_screen_fu == 2) %>% 
#   select(nid, date, response_id, start_date, au_db2:e4) %>% 
#   view()
# 
# duplicates_branch_match %>% 
#   filter(au_db1 == 2 & psb1 == 2 & osbb1 == 2 & ssab1 == 1 & 
#                  drugs_screen_fu == 2 & bpa1 == 2 & porn_screen_fu == 2) %>% 
#   select(nid, date, response_id, start_date, au_db2:e4) %>% 
#   view()
# 
# duplicates_branch_match %>% 
#   filter(au_db1 == 2 & psb1 == 2 & osbb1 == 2 & ssab1 == 1 & 
#                  drugs_screen_fu == 2 & bpa1 == 2 & porn_screen_fu == 1) %>% 
#   select(nid, date, response_id, start_date, au_db2:e4) %>% 
#   view()
# 
# duplicates_branch_match %>% 
#   filter(au_db1 == 2 & psb1 == 1 & osbb1 == 2 & ssab1 == 1 & 
#                  drugs_screen_fu == 2 & bpa1 == 2 & porn_screen_fu == 1) %>% 
#   select(nid, date, response_id, start_date, au_db2:e4) %>% 
#   view()
# 
# duplicates_branch_match %>% 
#   filter(au_db1 == 1 & psb1 == 2 & osbb1 == 2 & ssab1 == 2 & 
#                  drugs_screen_fu == 2 & bpa1 == 1 & porn_screen_fu == 2) %>% 
#   select(nid, date, response_id, start_date, au_db2:e4) %>% 
#   view()
# 
# duplicates_branch_match %>% 
#   filter(au_db1 == 2 & psb1 == 2 & osbb1 == 1 & ssab1 == 2 & 
#                  drugs_screen_fu == 2 & bpa1 == 2 & porn_screen_fu == 1) %>% 
#   select(nid, date, response_id, start_date, au_db2:e4) %>% 
#   view()
```

If answers differ only by 1-2 items (or 3 items if more than one branch endorsed and completed), keep more complete survey or if both complete keep first survey

```{r}
data <- data %>% 
  filter(!response_id %in% c("R_1DYDNJfbNuwRivW", "R_3w9vDPa7Aoq1lFD",
                             "R_22Gkq3271dAoUP2", "R_1gTtr4rJocjW0Uy",
                             "R_2uJW6wj5ne3i1wS", "R_3MGuKFZITFIe3NM",
                             "R_3MDR4RbykC162QV", "R_3Gq3wQfAmpYVFit",
                             "R_3Mn9DViM1ZJlQ1Q", "R_3dYXmYQcqJbtXbD",
                             "R_Ww9Ie3dTvQ58QbT", "R_1OVRbIUU6JzciJI",
                             "R_1P1q8xsYV2BQ3KG", "R_DclSImfNg9xma6B",
                             "R_3s17B90hYoNIXpy", "R_3Lb7H5oppSanIB0",
                             "R_Aafzxghrkp8ZNEl"))
```

Look at non-matching branch surveys

```{r}
duplicates %>% 
  filter(!response_id %in% duplicates_branch_match$response_id) %>% 
  select(nid, date, response_id, start_date, au_db1:e4) %>% 
  glimpse()
```

Duplicates by nid

```{r}
# total duplicates
duplicates %>% 
  group_by(nid) %>% 
  count() %>% 
  arrange(desc(n))

# days with duplicates
duplicates %>% 
  group_by(nid, date) %>%
  slice(1) %>% 
  group_by(nid) %>% 
  count() %>% 
  arrange(desc(n))
```

99 duplicates remaining

```{r}
duplicates <- data %>% 
  group_by(pid, date) %>% 
  count() %>% 
  ungroup() %>% 
  filter(n > 1) %>% 
  left_join(data, by = c("pid", "date")) %>% 
  filter(!is.na(n)) 

data %>% 
  group_by(pid, date) %>% 
  count() %>% 
   ungroup() %>% 
  filter(n > 1) %>% 
  arrange(desc(n)) %>% 
  print(n = Inf)
```

------------------------------------------------------------------------

Manually inspected remaining duplicates

Check how much time between duplicate surveys

```{r}
duplicates %>% 
  group_by(nid, date) %>% 
  summarize(time_between_dups = max(start_date) - min(start_date)) %>% 
  arrange(time_between_dups) %>% 
  print(n = Inf)
```

Look at duplicates more than 3 hours apart (3600 seconds = 1 hour)

```{r}
duplicates %>% 
  group_by(nid, date) %>% 
  summarize(time_between_dups = max(start_date) - min(start_date)) %>% 
  arrange(time_between_dups) %>% 
  filter(time_between_dups > 10800) %>% 
  print(n = Inf)

duplicates %>% 
  group_by(nid, date) %>% 
  summarize(time_between_dups = max(start_date) - min(start_date)) %>% 
  filter(time_between_dups > 10800) %>% 
  ungroup() %>% 
  left_join(duplicates, by = c("nid", "date")) %>% 
  select(nid, date, response_id, progress, everything()) %>% 
  glimpse()
```

```{r}
data <- data %>% 
  filter(!response_id %in% c("R_117vFnoNfgFOk4D", "R_d0WuHXIYc3QHGyl",
                             "R_2OSU9MciQO5OGhT"))
```

If progress \< 100 and another is 100 remove \< 100 duplicate

```{r}
data <- data %>% 
  filter(!response_id %in% c("R_3PzBQDOn70O3RHN", "R_2VgBsuP6FAg18p7", 
                             "R_2ZQxY4bcYnHkKVT", "R_2ANi9iaiZrRiK7W",
                             "R_zYcdQAFTkd4Wf85", "R_2RUMEtkgHOoKiU9",
                             "R_0HP8PsuElUEqq4N", "R_2DZw0MQSQ4Zv2M6",
                             "R_1Dqyd9EAWF6zkGf", "R_12KJL68mIqMDtil",
                             "R_3szg3OAQjR1LWAS", "R_2t36lXAL1Zxe8VG",
                             "R_ZIBMUETiZP7IX2F", "R_1JDaJzJxE3tFhJM",
                             "R_2s0dOdGygUSWdln", "R_2ysynCwzs7kOGy7",
                             "R_cIyJ7yF1Re01kC5", "R_3MPXwxSXDlhGQaI"))
```

```{r}
duplicates <- data %>% 
  group_by(pid, date) %>% 
  count() %>% 
  ungroup() %>% 
  filter(n > 1) %>% 
  left_join(data, by = c("pid", "date")) %>% 
  filter(!is.na(n)) 

data %>% 
  group_by(nid, date) %>% 
  count() %>% 
   ungroup() %>% 
  filter(n > 1) %>% 
  arrange(desc(n)) %>% 
  print(n = Inf)
```

For final ones, keep first survey (no way to determine which one is more accurate)

```{r}
first_surveys <- duplicates %>% 
  group_by(nid, date) %>% 
  arrange(date) %>% 
  slice(1)


data <- data %>% 
  filter((response_id %in% duplicates$response_id & !response_id %in% first_surveys$response_id) | (response_id %in% data$response_id & !response_id %in% duplicates$response_id))
```

All duplicates resolved

```{r}
duplicates <- data %>% 
  group_by(pid, date) %>% 
  count() %>% 
  ungroup() %>% 
  filter(n > 1) %>% 
  left_join(data, by = c("pid", "date")) %>% 
  filter(!is.na(n)) 

data %>% 
  group_by(nid, date) %>% 
  count() %>% 
   ungroup() %>% 
  filter(n > 1) %>% 
  arrange(desc(n)) %>% 
  print(n = Inf)
```

## Check number of surveys per unique participant

```{r}
data %>% 
  group_by(nid) %>% 
  count() %>% 
  arrange(desc(n)) %>% 
  print(n = Inf)
```

### Mean number of surveys completed: 23.5

```{r}
data %>%
  count(nid, name = "n_surveys") %>%
  summarise(
    total_completed = sum(n_surveys),
    total_possible  = n() * 28,
    mean_completed  = mean(n_surveys),
    completion_rate = mean(n_surveys) / 28
  )

# double-check mean # of surveys 
data %>%
  count(nid) %>%
  summarise(avg_surveys_completed = mean(n))

# median, SD, min, max 
data %>%
  count(nid, name = "n_surveys") %>%
  summarise(
    median_surveys = median(n_surveys),
    sd_surveys     = sd(n_surveys),
    min_surveys    = min(n_surveys),
    max_surveys    = max(n_surveys),
    n_participants = n()
  )
```

## Rename variables for consistency

```{r}
d <- rename_variables(data)
```

## Remove unnecessary variables

Either added during cleaning for checks or single value metadata columns

```{r}
d <- d %>% 
  select(-c(r_date, time, rt, rid, ssid, sms, sig,
            recipient_last_name, recipient_first_name, recipient_email,
            external_reference, distribution_channel, user_language)) %>% 
  relocate(nid, date) %>% 
  glimpse()
```

# Recoding, scoring, EDA

Daily behavioral screeners:

1 = Yes, 0 = No, 3 = Prefer not to say

```{r}
d <- d %>% 
  mutate(across(aub1:pub1, as.numeric)) %>% 
  mutate(across(c(aub1:psb1, osb1:ssb1, pub1),
               ~if_else(.x == 2, 0, .x)))

d <- d %>%  
  mutate(across(c(dub1:bpa),
               ~case_when(. == 2 ~ 0, 
                          . == 4 ~ 3,
                          TRUE ~ .)))
```

Dichotomous variables

1 = Yes, 0 = No

```{r}
d <- d %>%
  mutate(across(
    c(au_pg, au_dg, psb3, psb5, psb5a, er1_p, er2_p, 
      er3_p, er4_p, osb4, osb5, osb8, pss, er1_o, er2_o, 
      er3_o, er4_o, ssb2, er1_s, er2_s, er3_s, er4_s),
    ~ case_when(
      . == "1" ~ 1, # Yes
      . == "2" ~ 0, # No
      TRUE ~ as.numeric(.)
    )
  ))
```

## Active consent cues

### Verbal

To what extent did you do the following during the sexual activity?

`ver_pc`: Directly asked your partner or communicated verbally with your partner about consent

```{r}
psych::describe(d$ver_pc) # verbal
```

```{r}
d %>%
  pull(ver_pc) %>%
  hist(main = "Histogram of Verbal Cues",
       xlab = "Verbal Self-Report",
       col = "lightblue",
       breaks = 10)
```

### Direct nonverbal

To what extent did you do the following during the sexual activity?\

`enon_pc`: Used direct non-verbal signals to communicate with your partner about consent for the sexual activity

```{r}
psych::describe(d$enon_pc) # explicit nonverbal 
```

```{r}
d %>%
  pull(enon_pc) %>%
  hist(main = "Histogram of Direct Nonverbal",
       xlab = "Direct Nonverbal Self-Report",
       col = "lightblue",
       breaks = 10)
```

### Indirect nonverbal

To what extent did you do the following during the sexual activity?\

`inon_pc`: Used subtle signals to communicate with your partner about consent for the sexual activity

```{r}
psych::describe(d$inon_pc) # implicit nonverbal
```

```{r}
d %>%
  pull(inon_pc) %>%
  hist(main = "Histogram of Indirect Nonverbal",
       xlab = "Indirect Nonverbal Self-Report",
       col = "lightblue",
       breaks = 10)
```

### Nonverbal corr

```{r}
round(cor(d$enon_pc, d$inon_pc, use = "pairwise.complete.obs"), 2)
```

The correlation between the `direct` and `indirect nonverbal` consent cue items was *r* = .73, indicating a strong positive relationship that suggests these items reflect a shared underlying construct. For parsimony and theoretical clarity, these items will be averaged to create a continuous composite score representing overall nonverbal consent communication.

### Nonverbal composite

```{r}
d <- d %>%
  rowwise() %>%  # calculate mean score
  mutate(non_verb = mean(c(enon_pc,inon_pc)))

psych::describe(d$non_verb)
```

### Verbal - Nonverbal Correlation

```{r}
# Check correlation between verbal and nonverbal 
round(cor(d$ver_pc, d$non_verb, use = "pairwise.complete.obs"), 2)
```

## Type of sexual behavior

`psb2`: What activities occurred? (check all that apply)

Response options:

-   Kissing = 1;
-   Touching = 2;
-   Digital penetration (i.e., w/ fingers) = 3;
-   Oral sex = 4;
-   Vaginal sex = 5;
-   Anal sex = 6;
-   I tried but no sexual contact happened = 7

```{r}
d %>% select(psb2) %>% map(tabyl)

d$psb_act <- d$psb2

d <- d %>%
  mutate(psb_act = as.character(psb_act),
         psb_act = case_when(
           psb_act %in% c("1", "1,2", "2") ~ "Contact",
           psb_act == "7" ~ "Attempt",
           grepl("3", psb_act) | grepl("4", psb_act) | 
             grepl("5", psb_act) | grepl("6", psb_act) ~ "Penetration",
           TRUE ~ as.character(psb_act)))

d %>% select(psb_act) %>% map(tabyl)
```

`psb_di` 0 = Attempted sexual contact; 1 = Contact and/or penetration

```{r}
d$psb_di <- d$psb_act

d <- d %>%   
mutate(across(c(psb_di),
                ~dplyr::recode(.,
                               "Attempt" = 0,
                               "Contact" = 1,
                               "Penetration" = 1)))

d %>% select(psb_di) %>% map(tabyl)
```

## Partner gender

`psb4`: What was the gender of your partner?

Cisgender Man = 1; Cisgender Woman = 2; Trans, Queer, or Non-binary person = 3; Prefer not to say = 4; Not listed here = 5

```{r}
d %>% select(psb4) %>% map(tabyl)
```

## Sexual precedence

`psb_5`: Had you ever had sexual contact with this person in the past?

No = 0; Yes = 1

```{r}
d %>% select(psb5) %>% map(tabyl)

d <- d %>% 
    rename(precedence = psb5)
```

## Partner familiarity

`psb_6`: How did you know this other person?

I didn’t, we just met that day = 1; They are a friend = 2; They are an acquaintance = 3;\
They are my current or past dating/intimate partner = 4

```{r}
d %>% select(psb6) %>% map(tabyl)
```

#### 3-level with Stranger & Acquaintance grouped together  
```{r}
# Create a new variable 'fam_rank' for familiarity stratified across 3 ordered levels
d <- d %>%
  mutate(
    fam_rank = case_when(
      psb6 == 2 ~ "Friend",
      psb6 %in% c(1, 3) ~ "Stranger/Acq",
      psb6 == 4 ~ "Romantic",
      TRUE ~ NA_character_
    ),
    fam_rank = factor(fam_rank,
                      levels = c("Stranger/Acq", "Friend", "Romantic")))

# Verify the conversion
levels(d$fam_rank)
is.ordered(d$fam_rank)
table(d$fam_rank)
```

#### 3-level with Friend & Acquaintance grouped together 
```{r}
d <- d %>%
  mutate(
    fam_lev = case_when(
      psb6 == 1 ~ "Stranger",
      psb6 %in% c(2, 3) ~ "Friend/Acq",
      psb6 == 4 ~ "Romantic",
      TRUE ~ NA_character_
    ),
    fam_lev = factor(fam_lev,
                     levels = c("Stranger", "Friend/Acq", "Romantic")))

 # ordered = TRUE))
 # Verify the order
levels(d$fam_lev)
is.ordered(d$fam_lev)
table(d$fam_lev)
```


## Sexual feelings

### Arousal

To what extent did you feel the following during the sexual activity?\
`aro_pf`: I felt aroused.

```{r}
psych::describe(d$aro_pf) # arousal
```

```{r}
d %>%
  filter(psb_di == 1) %>%
  pull(aro_pf) %>%
  hist(main = "Histogram of Subjective Arousal",
       xlab = "Arousal Self-Report",
       col = "lightblue",
       breaks = 10)

d %>% select(aro_pf) %>% map(tabyl)
```

### Pleasure

To what extent did you feel the following during the sexual activity?\
`pls_pf`: I felt pleasure

```{r}
psych::describe(d$pls_pf) # pleasure
```

```{r}
d %>%
  filter(psb_di == 1) %>%
  pull(aro_pf) %>%
  hist(main = "Histogram of Subjective Pleasure",
       xlab = "Pleasure Self-Report",
       col = "lightblue",
       breaks = 10)
```

### Correlation

```{r}
round(cor(d$aro_pf, d$pls_pf, use = "pairwise.complete.obs"), 3)
```

### Composite

```{r}
d <- d %>%
  rowwise() %>%  # calculate mean score
  mutate(psb_feel = mean(c(pls_pf,aro_pf)))

psych::describe(d$psb_feel)
```

## Consent appraisal

To what extent did you feel the following during the sexual activity?\
\
`con_pf`: The sexual activity felt consensual.

```{r}
# psych::describe(d$con_pf) # consent evaluation
```

```{r}
d %>%
  filter(psb_di == 1) %>%
  pull(con_pf) %>%
  hist(main = "Histogram of Consent Appraisals",
       xlab = "'Felt consensual' Self-Report",
       col = "lightblue",
       breaks = 10)
```

## Substance use

### Participant drink count

`psb7` **renamed** `drinks`: How many drinks did you consume prior to or during this activity?

Response options: 0 = 1; 1-2 = 2, 3-4 = 3, 5-6 = 4, 7-9 = 5, 10+ = 6

```{r}
d %>%
  filter(psb_di == 1) %>%
  pull(psb7) %>%
  hist(main = "Histogram of Participant Drinks",
       xlab = "Self-Reported Drink Count",
       col = "lightblue",
       breaks = 10)

d %>% select(psb7) %>% map(tabyl)

d <- d %>% 
    rename(drinks = psb7)
```

-   Recode `psb_alc` from `drinks` such that 0 drinks = 0 and \>0 drinks = 1

```{r}
d <- d %>%
  mutate(psb_alc = if_else(drinks == 1, 0, if_else(drinks > 1, 1, drinks)))

d %>% select(psb_alc) %>% map(tabyl)
```

Participants endorsed `r nrow(subset(d, psb_alc == 1))` partnered sexual events following alcohol consumption.

### Participant intoxication

`psb8`: How intoxicated did you feel right before or during this sexual activity?

Least intoxicated ever felt in life (0) - Most intoxication ever felt in life (100) VAS

```{r}
psych::describe(d$psb8)

d %>%
  filter(psb_alc == 1) %>%
  pull(psb8) %>%
  hist(main = "Histogram of Participant Intoxication",
       xlab = "Self-Reported Intoxication",
       col = "lightblue",
       breaks = 10)
```

### Perceived partner intoxication

`psb9`: How intoxicated do you think the other person felt right before or during this sexual activity?

Least intoxicated ever felt in life (0) - Most intoxication ever felt in life (100) VAS

```{r}
d %>%
  filter(psb9 > 0) %>%
  pull(psb9) %>%
  hist(main = "Histogram of Partner Intoxication",
       xlab = "Perceived Partner Intoxication",
       col = "lightblue",
       breaks = 10)
```

### Intoxication parity 
```{r}
# Continuous parity = absolute difference between self and partner intoxication
d$parity_con <- abs(d$psb8 - d$psb9)
hist(d$parity_con)

d <- d %>%
  mutate(
    parity_cat = case_when(
      parity_con == 0 ~ "Equal",
      psb8 > psb9   ~ "Self-Higher",
      psb8 < psb9   ~ "Partner-Higher",
      TRUE ~ NA_character_
    ),
    parity_cat = factor(parity_cat,
                        levels = c("Equal","Self-Higher","Partner-Higher"))
  )
```

### Drug use (cannabis)

Response options endorsed:

-   0 = None;
-   1 = Marijuana, cannabis;
-   4 = Adderall, or another stimulant (e.g., Vyvanse, Ritalin);
-   9 = Xanax, or another sedative
-   7 = Other prescription medication.

`psb10`: Which of the following drugs were you using prior to or during this sexual activity?

```{r,message=FALSE}
d$psb_cub <- d$psb10

d <- d %>%   
mutate(across(c(psb_cub),
                ~dplyr::recode(., 
                              "0" = 0,
                              "1" = 1,
                              "4" = 0,
                              "7" = 0,
                              "7,1" = 1)))

# participant cannabis use pre-encounter
d %>% select(psb_cub) %>% map(tabyl) 
```

`psb11`: Which of the following drugs was the other person using prior to or during this sexual activity?

```{r}
d$partner_cub <- d$psb11

d <- d %>%   
mutate(across(c(partner_cub),
                ~dplyr::recode(., 
                              "0" = 0,
                              "1" = 1,
                              "9" = 0,
                              "7" = 0)))

# partner cannabis use pre-encounter
d %>% select(psb11, partner_cub) %>% map(tabyl)
```

## Affect

Just before the encounter, how were you feeling? Not at all (0) - Very much (4) VAS\
- `pa1_p` Excited\
- `na1_p` Irritable\
- `na2_p` Distressed\
- `na3_p` Angry\
- `na4_p` Empty\
- `na5_p` Ashamed\
- `pa2_p` Calm

Dichotomous var representing presence vs. absence of negative affect pre-event

```{r}
d <- d %>%
  rowwise() %>%  # calculate mean score
  mutate(neg_sum = sum(c( irri_p, dist_p, angr_p, empt_p, asha_p)))

d <- d %>%
  mutate(across(c(irri_p, dist_p, angr_p, empt_p, asha_p),
                ~ as.integer(. > 0),
                .names = "{sub('_p$', '_di', .col)}"))
d <- d %>%
  rowwise() %>%
  mutate(psb_neg = sum(irri_di, dist_di, angr_di, empt_di, asha_di))

d <- d %>%
  mutate(psb_neg_di = if_else(psb_neg == 0, 0, if_else(psb_neg > 0, 1, psb_neg)))

d %>% select(psb_neg_di) %>% map(tabyl)
```

**Emotion regulation:**

Thinking about your strongest emotion, how did you respond to the feeling?\
- `er1_p`: I tried to get rid of negative thoughts, feelings, or sensations\
- `er2_p`: I couldn’t stop thinking about my feelings\
- `er3_p`: I avoided expressing my feelings\
- `er4_p`: I changed the way I thought about what caused my feelings

```{r}
d %>% select(er1_p:er4_p) %>% map(tabyl)
```

**Pre-encounter expectations and stress:**

\- `exp_p`: Earlier in the day, how likely did you think it was that you would have sexual activity?\
- `st_p`: How stressful had the day been for you?

```{r}
d %>% select(exp_p, # Very unlikey (1) - Very likely (5) VAS
             st_p   # Not at all stressful (1) - Extremely Stressful (5) VAS
             ) %>% map(tabyl)

# expectations
psych::describe(d$exp_p)

# stress
psych::describe(d$st_p)
```

## Remove unnecessary measures

Vars from online and solo sexual behavior blocks

```{r}
d <- d %>% 
  select(-c(osb2, osb2.txt, osb6:osbb10_11_10_text, osbb15, osbb15_5_text,
            aro_of, pls_of, pss, exp_o, str_o:er4_o, ssb3, ssb3.txt,
            ssb6:er4_s, dub2.txt, med1_d:exp_d, dub3_bf.txt, dub3_du.txt,
            dub3_af.txt, status, q186_8_text, au_l:au_pbs.txt, 
            start_date:end_date, ip_address, recorded_date, 
            location_latitude, location_longitude, psb3, psb5a, psb6a:str_p.txt, 
            psb7a:psb15_tried_10_text, psb16_10_text:psb16_tried_10_text)) 
```

## Save updated dataframe for diary data

```{r,eval=FALSE}
d %>%
  summarise(across(everything(), ~ is.list(.x) | is.matrix(.x))) %>%
  pivot_longer(everything()) %>%
  filter(value == TRUE)
```

```{r}
d |> 
  write_csv(here::here(path_ready, "ready_cues.csv"))
```
