---
title: "Cleaning baseline data"
output: 
  html_document:
    toc: true 
    toc_depth: 4
editor_options: 
  chunk_output_type: console
---

```{r}
# to detect and warn about conflicts
library(conflicted)

conflict_prefer("filter", "dplyr")
conflict_prefer("select", "dplyr")
```

```{r}
# to read in data
library(readr)

path_nids <- "_data/data_process"
path_ready <- "_data/data_ready"

# for data wrangling and cleaning
library(tidyverse)
library(janitor)
library(lubridate)
library(psych)

source(here::here("_scripts/functions.R"))
```

Read in data

```{r, warning=FALSE}
baseline <- read_csv(here::here(path_nids,"baseline_nid.csv"), 
                     show_col_types = FALSE)

base_sona  <- read_csv(here::here(path_nids,"baseline_sona_id.csv"), 
                     show_col_types = FALSE)

data <- read_csv(here::here(path_ready, "ready_cues.csv"), 
                 show_col_types = FALSE)
```

Replace `sona_id` with new ID (`nid`) to ensure participant data remains
de-identified.

```{r}
names(base_sona)

identical(baseline$response_id, base_sona$response_id)

base_sona_updated <- base_sona %>%
  left_join(
    baseline %>% select(response_id, nid),
    by = "response_id"
  )

baseline <- base_sona_updated %>% 
  select(-c(sona_id, sona_id_confirm))

sum(is.na(baseline$nid))
```

Confirm number of unique participants and events (`pid`) in diary data.

```{r, warning=FALSE}
length(unique(data$nid)) # 278 - nid derived from sona_id; links baseline to daily surveys
length(unique(data$response_id)) # 6530 - event_id for daily surveys
```

## Subset data

Subset baseline to only include obs for which the same participant ID
(`nid`) also appears in the diary data.

```{r}
baseline_subset <- baseline %>%
  semi_join(data, by = "nid")

# Check that it worked
all(baseline_subset$nid %in% data$nid)
```

Subset diary data to only include obs for which the partnered sexual
behavior daily screener (`psb1`) was endorsed AND sexual contact
(`psb_di`) was reported.

```{r}
data %>% select(psb1, psb_di) %>% map(tabyl)

data_subset <- data %>%
  filter(psb1 == 1 & psb_di == 1)

data_subset %>%
  summarise(
    n_obs = n(),
    n_participants = n_distinct(nid)
  )
```

Further subset baseline to only include obs for participants who
reported partnered sexual behavior (`psb1`) involving sexual contact
(`psb_di`) at least once during the daily diary portion of the study by
removing rows from `baseline_subset` where that `nid` does not appear in
`data_subset` (i.e., remove participants from baseline who do not have
any psb1 == 1 & psb_di == 1 events.)

```{r}
base_ana <- baseline_subset %>%
  semi_join(data_subset, by = "nid")
```

### Remove unnecessary vars

```{r}
b <- base_ana %>% 
  select(-c(smu_1:sm_txt, sx_txt, re_txt, ders1:ders18, sd_txt, po_txt, mu_txt,
            sss1:sss23, cpa1:v_ar6, apb1:apb6, phq8_1:phq8_fu, gad7_1:gad7_7, 
            pcl_txt:pcl_20, sx_trade1:porn2, au_ven, pcl, sc0, tb2, pcl_s:hyp_c, 
            ar_txt, v_uc1:v_ar6, v_num, v_rev, v_poly, sss_tf, asrs_1:asrs_6, 
            ra_txt, cud_6m:cud8, aud_s:rma_s))
```

```{r}
# Clean up environment
rm(base_sona)
rm(base_sona_updated)
```

### Check for missing data
```{r}
colSums(is.na(b))[colSums(is.na(b)) > 0] # aud2 missing 4 obs
```

## Prepare between-subjects predictors

### Social Desirability

#### BIDR (a = .73)

-   Note that items 1, 3, 5, and 8 are already reverse-coded
-   Note that items 9, 11, 12 and 13 are already reverse-coded

```{r}
## BIDR (a = .73): (1-8) 1 = totally disagree, 8 = totally agree
#  Higher scores reflect greater social desirability bias

### Self-Deceptive Enhancement subscale (a = .63)

b <- b %>%
  rowwise() %>%
  mutate(sde_s = sum(bidr_1,bidr_2,bidr_3,bidr_4,bidr_5,bidr_6,bidr_7,bidr_8))

# create a character vector for the bidr items
sde_vector <- c("bidr_1","bidr_2","bidr_3","bidr_4","bidr_5","bidr_6","bidr_7","bidr_8")

# alpha = .63, i.e. < .70, doesn't meet standard criterion for reliability
psych::alpha(b[, sde_vector]) 

# describe
psych::describe(b$sde_s)
hist(b$sde_s)

### Impression Management subscale (a = .72)

b <- b %>%
  rowwise() %>%
  mutate(im_s = sum(bidr_9,bidr_10,bidr_11,bidr_12,bidr_13,bidr_14,bidr_15,bidr_16))

# create a character vector for the bidr items
im_vector <- c("bidr_9","bidr_10","bidr_11","bidr_12","bidr_13","bidr_14","bidr_15","bidr_16")

# alpha = .72, i.e. < .70, doesn't meet standard criterion for reliability
psych::alpha(b[, im_vector]) 

# describe
psych::describe(b$im_s)
hist(b$im_s)

### Total Scale
b <- b %>%
  rowwise() %>%
  mutate(bidr = sum(bidr_1,bidr_2,bidr_3,bidr_4,bidr_5,bidr_6,bidr_7,bidr_8,
                      bidr_9,bidr_10,bidr_11,bidr_12,bidr_13,bidr_14,bidr_15,bidr_16))

# create a character vector for the bidr items
bidr_vector <- c("bidr_1","bidr_2","bidr_3","bidr_4","bidr_5","bidr_6","bidr_7","bidr_8",
                 "bidr_9","bidr_10","bidr_11","bidr_12","bidr_13","bidr_14","bidr_15","bidr_16")

# alpha = .73, i.e. > .70, meets standard criterion for reliability
psych::alpha(b[, bidr_vector]) 

# describe
psych::describe(b$bidr)
hist(b$bidr)

# Grand-mean center for modeling (Level-2 predictor)
b$bidr_c <- b$bidr - mean(b$bidr)

b %>% select(bidr_1:bidr_16) %>% map(tabyl)
```

## Attitudes

### IRMA (a = .80)

```{r}
## IRMA (a = .80)
# 5 = strongly disagree, 4 = Somewhat disagree, 3 = Neither disagree nor agree, 2 = Somewhat agree, 1 = strongly agree 
# Item values summed for total score, with higher scores reflecting greater rejection of rape myths

b <- b %>%
  rowwise() %>%
  mutate(irma = sum(irma1,irma2,irma3,irma4,irma5,irma6,irma7))

# create a character vector for the irma items
rma_vector <- c("irma1","irma2","irma3","irma4","irma5","irma6","irma7")

# alpha = .80, i.e. > .70, meets standard criterion for reliability
psych::alpha(b[, rma_vector]) 

psych::describe(b$irma) # describe
hist(b$irma) # view distribution

# Grand-mean center for modeling (Level-2 predictor)
b$irma_c <- b$irma - mean(b$irma)
```

### Alcohol and sexual coercion - Individual (personal) attitudes
```{r}
b %>% select(asc1:asc4, coer1:coer6) %>% map(tabyl)

b <- b %>%
  rowwise() %>%
  mutate(asco = sum(asc1, asc2, asc3, asc4, 
                      coer1, coer2, coer3, coer4, coer5, coer6))

# Grand-mean center for modeling (Level-2 predictor)
b$asco_c <- b$asco - mean(b$asco)

# create a character vector for the pa items
ascoer_vec <- c("asc1", "asc2", "asc3", "asc4", 
                "coer1", "coer2","coer3","coer4","coer5","coer6")

# alpha > .70 meets standard criterion for reliability
psych::alpha(b[, ascoer_vec], check.keys=TRUE) 
```

Coercion PBCS items separate from ASC items
```{r}
b %>% select(coer1:coer6) %>% map(tabyl)

b <- b %>%
  rowwise() %>%
  mutate(coer_s = sum(coer1,coer2,coer3,coer4,coer5,coer6))

# create a character vector
coer_vec <- c("coer1","coer2","coer3","coer4","coer5","coer6")

# alpha = .88, i.e. > .70, meets standard criterion for reliability
psych::alpha(b[, coer_vec], na.rm = T) 
```

### Alcohol and sexual coercion - Perceived peer attitudes
```{r}
b %>% select(pa1:pa6) %>% map(tabyl)

b <- b %>%
  rowwise() %>%
  mutate(ppat = sum(pa1, pa2, pa3, pa4, pa5, pa6))

# Grand-mean center for modeling (Level-2 predictor)
b$ppat_c <- b$ppat - mean(b$ppat)

# create a character vector
pa_vec <- c("pa1","pa2","pa3","pa4","pa5","pa6")

# alpha i.e. > .70, meets standard criterion for reliability
psych::alpha(b[, pa_vec], check.keys=TRUE)

cor.test(b$ppat_c, b$asco_c)
```


## Baseline behavior

#### AUDIT (a = .80)

*recalculate summed total post-imputation since aud2 is missing 4 obs*
```{r}
b %>% select(aud1:aud10) %>% map(tabyl)

# AUDIT summed score 
b <- b %>% 
rowwise() %>% dplyr::mutate(auds = sum(aud1,aud2,aud3,aud4,aud5,aud6,aud7,aud8,aud9,aud10,na.rm = T))

# AUDIT descriptives
psych::describe(b$auds)

# create a character vector for the audit items
audit_vector <- c("aud1","aud2","aud3","aud4","aud5",
                  "aud6","aud7","aud8","aud9","aud10")

psych::alpha(b[, audit_vector], check.keys = T, na.rm = TRUE) # alpha = .80
hist(b$auds)

# Grand-mean center for modeling (Level-2 predictor)
b$auds_c <- b$auds - mean(b$auds, na.rm = T)
```

#### Sexual Risk Behavior

```{r}
b %>% select(srb1, srb2, srb3, # neglible variability for srb2 and srb5
             srb4, srb5, srb6, srb7, srb8) %>% map(tabyl)

# create a character vector for the srb items
srb_vector <- c("srb1","srb2","srb3","srb4","srb5","srb6","srb7","srb8")

# a = .65
psych::alpha(b[, srb_vector], na.rm = T) 

# drop srb2 and srb5
srb_vector <- c("srb1","srb3","srb4","srb6","srb7","srb8")

# a = .68
psych::alpha(b[, srb_vector], na.rm = T) 

# create sum total score
b <- b %>%
  rowwise() %>%
  mutate(srbs = sum(srb1, srb3, srb4, srb6, srb7, srb8))

# view descriptive statistics
psych::describe(b$srbs)

# view distribution
hist(b$srbs)

# grand-mean center
b$srbs_c <- b$srbs - mean(b$srbs, na.rm = T)
```

#### Verbal Consent (a = .77)

-   `scs8`: **v_in:** I always ask verbally for consent before I
    initiate a sexual encounter
-   `scs9`: **v_on:** I always ask verbally for consent at each
    step of a sexual encounter
-   `ong1`: If my partner seems less than excited about sex, I will stop
    and ask if they want to be sexual with me
-   `ong2`: If my partner is not expressing physical affection toward me
    during sex, I check in with them to make sure they want to have sex,
    even if they verbally agreed to sex
-   `ong3`: If I am unclear about my partner’s body language I make sure
    to verbally check in with them to be sure that they want to have sex
-   `ong4`: I pay attention to my partner’s body language during sexual
    encounters to be sure that they want to have sex

```{r}
b %>% select(scs8, scs9, ong1, ong2, ong3, ong4) %>%
  map(tabyl)

b <- b %>% 
    rename(v_in = scs8,
           v_on = scs9)

# create a character vector
vrb_vector <- c("v_in", "v_on", "ong1", "ong2", "ong3", "ong4")

# a = .77
psych::alpha(b[, vrb_vector], na.rm = T) 

# create sum total score
b <- b %>%
  rowwise() %>%
  mutate(ver_b = sum(v_in, v_on, ong1, ong2, ong3, ong4))

# view descriptive statistics
psych::describe(b$ver_b)

# view distribution
hist(b$ver_b)

# Grand-mean center for modeling (Level-2 predictor)
b$ver_bc <- b$ver_b - mean(b$ver_b, na.rm = T)
```

## Save updated dataframe

```{r}
b |> 
  write_csv(here::here(path_ready, "ready_base.csv"))
```

```{r}
data_subset |> 
  write_csv(here::here(path_ready, "diary_sub.csv"))
```
