---
title: EDA 
author: Stephanie Ward
editor_options: 
  chunk_output_type: console
---

```{r}
library(conflicted)
conflict_prefer("filter", "dplyr")
conflict_prefer("select", "dplyr")

library(tidyverse)
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(lubridate)
library(janitor)

path_ready <- "_data/data_ready"
```

### Setup and merge

Read in data

```{r}
b <- read_csv(here::here(path_ready, "ready_base.csv"), show_col_types = FALSE)

data_subset <- read_csv(here::here(path_ready, "diary_sub.csv"), show_col_types = FALSE)
```

Confirm diary is in long format

```{r}
data_subset %>%
  count(nid) %>%
  summarise(median=median(n), max=max(n), prop_with_repeats=mean(n>1))
```

Confirm types, ensure tidy events

```{r}
b <-  b %>%
  mutate(
    nid = as.factor(nid))

diary_long <- data_subset %>%
  mutate(
    nid = as.factor(nid),
    date = as.Date(date),
    event_id = response_id   # unique event key
  ) %>%
  arrange(nid, date) %>%
  group_by(nid) %>%
  mutate(event_num = row_number()) %>%
  ungroup()
```

Merge baseline and diary

```{r}
d <- diary_long %>%
  left_join(b %>% distinct(nid, .keep_all = TRUE), by = "nid")
```

## Consent cue distributions

### Sliding-scale (VAS) responses

Forced-response items with default set to 0, manually inspected obs = 0
(examples below)

```{r, eval=FALSE}
# view subject IDs w/ at least 1 encounter for which they endorsed 
# "Not at all" across all external and internal cues. 
d %>% 
  filter(psb1 == 1, 
         ver_pc == 0, enon_pc == 0, inon_pc == 0,
         con_pf == 0, aro_pf == 0, pls_pf == 0) %>%
  select(nid) %>% map(tabyl)

# Check how many sexual events included just "attempts" or kissing/touching
d %>% select(psb_act) %>% map(tabyl)

# View subject IDs w/ at least 1 encounter involving penetration for which
# they endorsed "Not at all" across all external and internal cues
d %>% 
  filter(psb1 == 1, psb_act == "Penetration", 
         ver_pc == 0, enon_pc == 0, inon_pc == 0,
         con_pf == 0, aro_pf == 0, pls_pf == 0) %>%
  select(nid) %>% map(tabyl)
```

Legit

```{r, eval=FALSE}
merged_data %>% # looks legit, response: R_0oexjZcflARrq9P
  filter(nid == 2351222, psb1 == 1) %>% view()

merged_data %>% # looks legit, response: R_1q4I2PR1MOtNOas
  filter(nid == 2460338, psb1 == 1, ) %>% view()

merged_data %>% # legit response: R_3NxHqUwX3ATt3o7 (co-occurring en-bloc AIB)
  filter(nid == 6191138, psb1 == 1) %>% view()

merged_data %>% # legit response: R_CmK5aMPfxuRuIed (endorsed victimization)
  filter(nid == 7109663, psb1 == 1, psb_act == "Penetration") %>% view()

merged_data %>% # legit response: R_1KqhJP8hN0eu2AT (bodily contact only)
  filter(nid == 3722889, psb1 == 1, ) %>% view()

merged_data %>% # legit response: R_1KqhJP8hN0eu2AT (bodily contact only)
  filter(nid == 5359974, psb1 == 1, ) %>% view()

merged_data %>% # legit response: 3 events, 1 penetrative, observed variability 
  filter(nid == 8365590, psb1 == 1) %>% view()
```

Low-quality

```{r, eval=FALSE}
merged_data %>% # straightlining: R_4Pjqjwp0mwiiwsF
  filter(nid == 8890545, psb1 == 1) %>% view()

merged_data %>% # straightlining: R_1rDt67OsSeVdJdD
  filter(nid == 1948818, psb1 == 1) %>% view()

merged_data %>% # straightlining: R_1IiVp3zqi97TBIF or R_3fVPZSasG72CF7b
  filter(nid == 9128298, psb1 == 1) %>% view()

merged_data %>% # incomplete response: R_4Pjqjwp0mwiiwsF 
  filter(nid == 8890545, psb1 == 1) %>% view() # prompted review for flagged "duplicate"
# to see if corrected response from participant was deleted after they accidentally 
# endorsed PSB when they meant to report solo (porn consumption, no consent items)
```

### Verbal

-   `ver_pc`: Directly asked your partner or communicated verbally with
    your partner about consent?

```{r}
d <- d %>% filter(!is.na(ver_pc))

d %>%
  pull(ver_pc) %>%
  hist(main = "Histogram of Continuous Verbal (0-10)",
       xlab = "Verbal Self-Report",
       col = "lightblue",
       breaks = 10)
```

```{r}
d <- d %>%
  mutate(
    verb_bins = cut(
      ver_pc,
      breaks = c(-Inf, 0, 3, 6, 9, Inf),
      labels = c("Not at all", "A little", 
                 "Somewhat", "Quite a bit", "Very much"),
      right = TRUE,
      include.lowest = TRUE),
    verb_bins = ordered(verb_bins,
                        levels = c("Not at all", "A little", 
                                   "Somewhat", "Quite a bit", "Very much")))

# Verify
is.ordered(d$verb_bins)
table(d$verb_bins, useNA = "ifany")
```

```{r}
d %>%
  ggplot(aes(x = verb_bins)) +
  geom_bar(fill = "lightblue", color = "black") +
  labs(title = "Distribution of Verbal Consent (Ordinal)",
       x = "Verbal Cue Endorsement",
       y = "Count")
```

### Nonverbal

Composite of explicit (direct) and implicit (indirect)

-   `enon_pc`: Used direct non-verbal signals to communicate with your
    partner about consent for the sexual activity
-   `inon_pc`: Used subtle signals to communicate with your partner
    about consent for the sexual activity

```{r}
d %>%
  pull(non_verb) %>%
  hist(main = "Histogram of Continuous Nonverbal (0-10)",
       xlab = "Nonverbal Composite Score",
       col = "lightblue",
       breaks = 10)
```

```{r}
# Create ordered bins for nonverbal consent cues
d <- d %>%
  mutate(
    nonvb_bins = cut(
      non_verb,
      breaks = c(-Inf, 0, 3, 6, 9, Inf),
      labels = c("Not at all", "A little", 
                 "Somewhat", "Quite a bit", "Very much"),
      right = TRUE,
      include.lowest = TRUE
    ),
    nonvb_bins = ordered(nonvb_bins,
                         levels = c("Not at all", "A little", 
                                    "Somewhat", "Quite a bit", "Very much")))
# Verify
is.ordered(d$nonvb_bins)
table(d$nonvb_bins, useNA = "ifany")
```

```{r}
d %>%
  ggplot(aes(x = nonvb_bins)) +
  geom_bar(fill = "lightblue", color = "black") +
  labs(title = "Distribution of Nonverbal Consent (Ordinal)",
       x = "Nonverbal Cue Endorsement",
       y = "Count")
```

## Between-person convergence

### Verbal

-   `verbb_init`: I always ask verbally for consent before I initiate a
    sexual encounter
-   `verbb_ong`: I always ask verbally for consent at each step of a
    sexual encounter

```{r}
verbal_means <- d %>%
  group_by(nid) %>%
  summarise(
    mean_ver_pc = mean(ver_pc, na.rm = TRUE),
    n_obs = sum(!is.na(ver_pc))
  ) %>%
  ungroup()

d <- d %>%
  left_join(verbal_means, by = "nid")

round(cor(d$verbb_init, d$mean_ver_pc, use = "pairwise.complete.obs"), 2)
```

### Nonverbal

-   `scs6` **renamed** `non_vrb_bsl:` Typically, I communicate sexual
    consent to my partner using nonverbal signals and body language

```{r}
d <- d %>% 
    rename(non_vrb_bsl = scs6)

nonverb_means <- d %>%
  group_by(nid) %>%
  summarise(
    mean_nonverb = mean(non_verb, na.rm = TRUE),
    n_obs = sum(!is.na(non_verb))
  ) %>%
  ungroup()

d <- d %>%
  left_join(nonverb_means, by = "nid")

round(cor(d$non_vrb_bsl, d$mean_nonverb, use = "pairwise.complete.obs"), 2)
```

```{r}
d <- d %>%
  mutate(
    act_c = if_else(psb_act == "Penetration", 0.5, -0.5))
```

## Do different types of people use the cue measures differently?

Comparing distributions across groups and behaviors:

### Consent by gender

```{r}
d %>%
  mutate(gender = if_else(as.character(gend_di) == "1", "Men", "Women/GNC")) %>%
  pivot_longer(c(ver_pc, non_verb),
               names_to = "outcome", values_to = "value",
               values_transform = list(value = as.numeric)) %>%
  ggplot(aes(value)) +
  geom_histogram(binwidth = 1, boundary = 0, closed = "left", color = "white") +
  facet_grid(gender ~ outcome, scales = "free_x") +
  labs(x = "Outcome value", y = "Count",
       title = "Outcome distributions by gender")

# as per recommendation of Brauer & Curtin
d <- d %>% mutate(gend_c = if_else(gend_di == 1, 
                                    0.5, # = Men
                                   -0.5, # = Women/GNC
                                   missing = NA_real_))

d %>% select(gend, gend_di, gend_c) %>% map(tabyl)
```

### Consent by behavior

```{r}
d %>% select(psb_act) %>% map(tabyl)

d %>%
  mutate(
    psb_act = factor(psb_act, levels = c("Contact", "Penetration"))  # fix order
  ) %>%
  filter(!is.na(psb_act)) %>%                                        # drop NAs
  pivot_longer(
    c(ver_pc, non_verb),
    names_to = "outcome", values_to = "value",
    values_transform = list(value = as.numeric)
  ) %>%
  ggplot(aes(value)) +
  geom_histogram(binwidth = 1, boundary = 0, closed = "left", color = "white") +
  facet_grid(psb_act ~ outcome, scales = "free_x") +
  labs(x = "Outcome value", y = "Count",
       title = "Outcome distributions by sexual act (psb_act)") 

# + theme_classic(base_size = 12)
```

**Nonverbal (Contact vs Penetration)**
```{r}
d %>% filter(psb_act == "Contact") %>% 
  pull(non_verb) %>%
  hist(main = "Histogram of Nonverbal Consent (Contact)",
       xlab = "Nonverbal Composite Score",
       col = "lightblue",
       breaks = 10)

d %>%  filter(psb_act == "Penetration") %>%
  pull(non_verb) %>%
  hist(main = "Histogram of Nonverbal Consent (Penetration)",
       xlab = "Nonverbal Composite Score",
       col = "lightblue",
       breaks = 10)
```


**Verbal (Contact vs Penetration)**
```{r}
d %>% filter(psb_act == "Contact") %>% 
  pull(ver_pc) %>%
  hist(main = "Histogram of Verbal Consent (Contact)",
       xlab = "Verbal Composite Score",
       col = "lightblue",
       breaks = 10)

d %>%  filter(psb_act == "Penetration") %>%
  pull(ver_pc) %>%
  hist(main = "Histogram of Verbal Consent (Penetration)",
       xlab = "Verbal Composite Score",
       col = "lightblue",
       breaks = 10)

# as per recommendation of Brauer & Curtin
d <- d %>% mutate(behav_c = if_else(psb_act == "Penetration", 0.5, -0.5, missing = NA_real_))

d %>% select(psb_act, behav_c) %>% map(tabyl)
```

### Greek life

#### Nonverbal

```{r}
d %>% select(s_life) %>% map(tabyl)

d %>% filter(s_life == "Greek life") %>% select(psb_act) %>% map(tabyl)

d %>% filter(s_life == "Greek life") %>% 
  pull(non_verb) %>%
  hist(main = "Histogram of Nonverbal Consent (Greek Life)",
       xlab = "Nonverbal Composite Score",
       col = "lightblue",
       breaks = 10)

d %>% 
  pull(non_verb) %>%
  hist(main = "Histogram of Nonverbal Consent (Full sample)",
       xlab = "Nonverbal Composite Score",
       col = "lightblue",
       breaks = 10)
```

#### Verbal

```{r}
d %>% filter(s_life == "Greek life") %>% 
  pull(ver_pc) %>%
  hist(main = "Histogram of Verbal Consent (Greek Life)",
       xlab = "Verbal Composite Score",
       col = "lightblue",
       breaks = 10)

d %>% 
  pull(ver_pc) %>%
  hist(main = "Histogram of Verbal Consent (Full sample)",
       xlab = "Verbal Composite Score",
       col = "lightblue",
       breaks = 10)
```

### Debut

```{r}
d %>%
  filter(life_prt == 0, psb_act == "Penetration") %>%
  summarise(unique_participants = n_distinct(nid))

d %>%
  filter(life_prt == 0, psb_act == "Penetration") %>%
  summarise(unique_events = n_distinct(event_id))

d %>%
  filter(life_prt == 0, psb_di == 1) %>%
  summarise(unique_participants = n_distinct(nid))

d %>%
  filter(life_prt == 0, psb_di == 1) %>%
  summarise(unique_events = n_distinct(event_id))
```

#### Nonverbal (vs. Experienced) for Penetration

```{r}
d %>% filter(life_prt == 0, psb_act == "Penetration") %>% 
  pull(non_verb) %>%
  hist(main = "Histogram of Nonverbal Consent (Debut)",
       xlab = "Nonverbal Composite Score",
       col = "lightblue",
       breaks = 10)

d %>% filter(life_prt >= 0, psb_act == "Penetration") %>% 
  pull(non_verb) %>%
  hist(main = "Histogram of Nonverbal Consent (Experienced)",
       xlab = "Nonverbal Composite Score",
       col = "lightblue",
       breaks = 10)
```

#### Verbal (vs. Experienced) for Penetration

```{r}
d %>% filter(life_prt == 0, psb_act == "Penetration") %>% 
  pull(ver_pc) %>%
  hist(main = "Histogram of Verbal Consent (Debut)",
       xlab = "Verbal Composite Score",
       col = "lightblue",
       breaks = 10)

d %>% filter(life_prt >= 0, psb_act == "Penetration") %>% 
  pull(ver_pc) %>%
  hist(main = "Histogram of Verbal Consent (Experienced)",
       xlab = "Verbal Composite Score",
       col = "lightblue",
       breaks = 10)
```


```{r}
d |> 
  write_csv(here::here(path_ready, "ready_merg.csv"))
```
